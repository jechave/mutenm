---
title: "Introduction to mutenm"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to mutenm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 4
)
```

The `mutenm` package builds Elastic Network Models (ENMs) of proteins and simulates mutation effects using linear response theory.

## Installation

```{r eval=FALSE}
# Install from GitHub
devtools::install_github("jechave/mutenm")
```

## Quick Start

```{r message=FALSE}
library(mutenm)
```

### Step 1: Build an ENM

Read a PDB structure and create the elastic network model:

```{r}
# Read PDB file (2acy is acetylcholinesterase)
pdb <- bio3d::read.pdb(system.file("extdata", "2acy.pdb", package = "mutenm"))

# Build the ENM
wt <- enm(pdb, node = "ca", model = "anm", d_max = 10.5)
```

The `enm()` function returns a protein object containing:

- Node coordinates and residue information
- Network graph (edges and spring constants)
- Normal mode analysis results (eigenvalues, eigenvectors, covariance matrix)

### Step 2: Simulate a Single Mutation

Create a mutant by perturbing the contacts around a specific site:

```{r}
# Mutate site 50
mut <- mutenm(wt, site_mut = 50, mutation = 1, mut_model = "lfenm", seed = 123)
```

The mutation is modeled as random perturbations to spring lengths around the mutated site. The structural response is calculated using linear response theory.

You can calculate the displacement between wild-type and mutant:

```{r}
# Displacement at each site
dxyz <- mut$nodes$xyz - wt$nodes$xyz
dr2 <- rowSums(matrix(dxyz^2, ncol = 3, byrow = TRUE))

# Plot displacement profile
plot(dr2, type = "l", xlab = "Site", ylab = "Squared displacement",
     main = "Response to mutation at site 50")
abline(v = 50, lty = 2, col = "red")
```

### Step 3: Mutation Response Scanning

For a systematic analysis, use `mrs()` to scan all sites:

```{r}
# Scan all sites (using nmut=1 for speed; use 10+ for production)
result <- mrs(pdb, pdb_id = "2ACY", nmut = 1, seed = 42)
```

The `mrs()` function returns:

- `dr2ij`: Response matrix (nsites x nsites) - displacement at site i from mutation at j
- `influence`: Column means - effect of mutating each site
- `sensitivity`: Row means - response of each site to mutations anywhere
- `params`: Parameters used

### Step 4: Visualize Results

Use `plot_mrs()` to create a publication-ready figure:

```{r fig.width=8, fig.height=5}
plot_mrs(result)
```

The plot shows:

- **Response matrix**: How mutations propagate through the structure
- **Influence profile**: Sites where mutations cause large effects (high influence)
- **Sensitivity profile**: Sites that respond strongly to mutations anywhere (high sensitivity)

### Saving the Figure

For publications, save as PDF:

```{r eval=FALSE}
p <- plot_mrs(result)
ggplot2::ggsave("mrs_figure.pdf", p, width = 8, height = 5)
```

## Function Reference

| Function | Description |
|----------|-------------|
| `enm()` | Build an ENM from a PDB structure |
| `mutenm()` | Simulate a mutation at a specific site |
| `mrs()` | Mutation Response Scanning - scan all sites |
| `plot_mrs()` | Visualize MRS results |

## Key Parameters

### ENM Parameters (`enm()`)

| Parameter | Description | Default |
|-----------|-------------|---------|
| `node` | Node type: "ca", "cb", or "sc" | "ca" |
| `model` | ENM model: "anm", "ming_wall", etc. | "anm" |
| `d_max` | Distance cutoff (Angstroms) | 10.5 |

### Mutation Parameters (`mrs()`, `mutenm()`)

| Parameter | Description | Default |
|-----------|-------------|---------|
| `mut_model` | "lfenm" (fast) or "sclfenm" | "lfenm" |
| `nmut` | Mutations per site (mrs only) | 1 |
| `mut_dl_sigma` | Perturbation magnitude | 0.3 |
| `seed` | Random seed for reproducibility | NULL |

## Interpretation

- **High influence sites**: Mutations here cause large structural changes throughout the protein. Often buried, well-connected residues.

- **High sensitivity sites**: These regions respond to mutations anywhere. May indicate functionally important or structurally coupled regions.

- **Diagonal of response matrix**: Self-response (how much the mutated site itself moves).

- **Off-diagonal patterns**: Reveal structural communication pathways and allosteric coupling.
