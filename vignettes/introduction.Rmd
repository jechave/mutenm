---
title: "Introduction to mutenm"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to mutenm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
```

The `mutenm` package builds Elastic Network Models (ENMs) of proteins and simulates mutation effects using linear response theory. This vignette provides a quick introduction to get you started.

## What is an Elastic Network Model?

An Elastic Network Model (ENM) represents a protein as a network of nodes connected by harmonic springs:

- **Nodes** are typically placed at the positions of alpha carbons (Cα), one per residue
- **Springs** connect nearby nodes (within a cutoff distance)
- **Normal modes** describe the collective motions of the network

The key insight is that the low-frequency normal modes of this simple model capture the large-scale, functionally relevant motions of proteins surprisingly well, despite ignoring most atomic detail.

## Why simulate mutations?

Mutations can alter protein structure, dynamics, and function. The `mutenm` package uses linear response theory to predict how mutations propagate structural effects through the protein network:

1. A mutation is modeled as a perturbation to the spring lengths around the mutated site
2. The structural response is calculated using: **δr = C × f** (displacement = covariance × force)
3. This is much faster than full molecular dynamics while capturing the essential physics

## Installation

```{r eval=FALSE}
# Install from GitHub
devtools::install_github("jechave/mutenm")
```

## Quick Start: The Three-Step Workflow

```{r message=FALSE}
library(mutenm)
library(ggplot2)
```

### Step 1: Build the ENM

Read a PDB structure and create the elastic network model:

```{r}
# Read PDB file (2acy is acetylcholinesterase from Torpedo californica)
pdb <- bio3d::read.pdb(system.file("extdata", "2acy.pdb", package = "mutenm"))

# Build the ENM
wt <- enm(pdb, node = "ca", model = "ming_wall", d_max = 10.5)
```

The `wt` object (wild-type) now contains:

- Network parameters (node type, model, cutoff)
- Node information (coordinates, residue numbers)
- The network graph (edges, spring constants)
- Normal mode analysis results (eigenvalues, eigenvectors, covariance matrix)

### Step 2: Analyze the wild-type protein

Calculate structural and dynamic properties:

```{r}
# Get residue numbers for plotting
sites <- wt$nodes$pdb_site

# Mean-square fluctuation per site (captures flexibility)
msf <- msfi(wt)

# Contact number per site (captures local packing)
contacts <- cn(wt)
```

Visualize the flexibility profile:

```{r msf-profile, fig.cap="Mean-square fluctuation profile showing flexible (peaks) and rigid (valleys) regions."}
df <- data.frame(site = sites, msf = msf)
ggplot(df, aes(x = site, y = msf)) +
  geom_line(color = "steelblue") +
  labs(x = "Residue", y = "Mean-Square Fluctuation",
       title = "Flexibility Profile of 2ACY") +
  theme_minimal()
```

### Step 3: Simulate a mutation

Create a mutant by perturbing the contacts around a specific site:

```{r}
# Mutate site 50
mut <- mutenm(wt, site_mut = 50, mutation = 1, mut_model = "lfenm", seed = 123)

# Calculate structural displacement at each site
dr2 <- Dr2i(wt, mut)

# Calculate energy change
dv <- Dv_min(wt, mut)
cat("Energy change (stress):", round(dv, 3), "\n")
```

Visualize where the structure moves:

```{r displacement-profile, fig.cap="Structural displacement caused by mutation at site 50. The mutation site (dashed line) shows the largest displacement."}
df <- data.frame(site = sites, dr2 = dr2)
ggplot(df, aes(x = site, y = dr2)) +
  geom_line(color = "darkred") +
  geom_vline(xintercept = sites[50], linetype = "dashed", alpha = 0.5) +
  labs(x = "Residue", y = "Squared Displacement",
       title = "Structural Response to Mutation at Site 50") +
  theme_minimal()
```

## Function Overview

The package provides 20 exported functions organized into three categories:

### Core Functions

| Function | Description |
|----------|-------------|
| `enm()` | Build an ENM from a PDB structure |
| `mutenm()` | Simulate a mutation at a specific site |
| `mrs()` | Mutation Response Scanning - scan all sites systematically |

### Single-Protein Properties

Functions that analyze one protein structure:

| Function | Description |
|----------|-------------|
| `cn()` | Contact number per site |
| `wcn()` | Weighted contact number per site |
| `dactive()` | Distance to active site |
| `msfi()` | Mean-square fluctuation per site |
| `msfn()` | Mean-square fluctuation per mode |
| `v_min()` | Minimum (stress) energy |
| `g_ent()` | Entropic free energy |
| `dv_act()` | Activation energy (internal) |
| `dg_ent_act()` | Activation energy (entropic) |

### Mutation Effect Functions

Functions that compare wild-type and mutant:

| Function | Description |
|----------|-------------|
| `Dr2i()` | Squared displacement per site |
| `Dr2n()` | Squared displacement per mode |
| `Dmsfi()` | Change in MSF per site |
| `Dmsfn()` | Change in MSF per mode |
| `Dv_min()` | Change in minimum energy |
| `Dg_ent()` | Change in entropic free energy |
| `Ddv_act()` | Change in activation energy |
| `Ddg_ent_act()` | Change in activation entropy |

## Next Steps

To learn more, explore the other vignettes:

- **Building Elastic Network Models**: Deep dive into ENM construction, node types, and model variants
- **Protein Structure and Dynamics**: Analyzing single proteins with contact numbers and fluctuations
- **Simulating Mutations**: Understanding the mutation models and parameters
- **Mutation Response Scanning**: Systematic analysis of all mutation sites
